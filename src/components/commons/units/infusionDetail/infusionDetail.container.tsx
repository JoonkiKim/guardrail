import React, { useState, useEffect } from "react";
import { useRouter } from "next/router";
import { useQuery, useMutation } from "@apollo/client";
import {
  FETCH_INFUSION,
  UPDATE_INFUSION,
  DELETE_INFUSION,
} from "../../../../commons/apis/graphql-queries";
import CheckModal from "../../../commons/modals/checkModal";
import AlertModal from "../../../commons/modals/alertModal";
import {
  Container,
  TopAppBar,
  AppBarContent,
  AppInfo,
  AppTitle,
  AppSubtitle,
  BackButton,
  ActionButtons,
  ActionButton,
  ContentWrapper,
  Card,
  CardHeader,
  CardTitle,
  CardContent,
  TitleSection,
  Title,
  CategoryBadge,
  DateText,
  Description,
  ThoughtsSection,
  ThoughtItem,
  ThoughtHeader,
  ThoughtTitle,
  ThoughtIcon,
  ThoughtLabel,
  ThoughtArrow,
  ThoughtContent,
  ThoughtTextarea,
  ButtonGroup,
  Button,
  COLORWAYS,
} from "./infusionDetail.style";

interface InfusionDetailContainerProps {
  theme?: keyof typeof COLORWAYS;
}

// PeriodType enum (GraphQL Ïä§ÌÇ§ÎßàÏôÄ ÏùºÏπò)
enum PeriodType {
  ONE_WEEK = "ONE_WEEK",
  ONE_MONTH = "ONE_MONTH",
  ONE_YEAR = "ONE_YEAR",
  TEN_YEARS = "TEN_YEARS",
}

export default function InfusionDetailContainer({
  theme = "forest",
}: InfusionDetailContainerProps) {
  const router = useRouter();
  const { infusionId } = router.query;
  const [thoughts, setThoughts] = useState<Record<string, string>>({
    ONE_WEEK: "",
    ONE_MONTH: "",
    ONE_YEAR: "",
    TEN_YEARS: "",
  });
  const [isSaving, setIsSaving] = useState(false);
  const [designOption, setDesignOption] = useState<
    "accordion" | "tabs" | "scroll"
  >("accordion");
  const [expandedThoughts, setExpandedThoughts] = useState<
    Record<string, boolean>
  >({
    ONE_WEEK: false,
    ONE_MONTH: false,
    ONE_YEAR: false,
    TEN_YEARS: false,
  });
  const [showSuccess, setShowSuccess] = useState(false);
  const [showError, setShowError] = useState(false);
  const [errorMessage, setErrorMessage] = useState("");
  const [showDeleteModal, setShowDeleteModal] = useState(false);
  const [showDeleteSuccessModal, setShowDeleteSuccessModal] = useState(false);
  const [showDeleteErrorModal, setShowDeleteErrorModal] = useState(false);
  const [deleteErrorMessage, setDeleteErrorMessage] = useState("");
  const [showUpdateSuccessModal, setShowUpdateSuccessModal] = useState(false);

  const currentTheme = COLORWAYS[theme];

  // GraphQL ÏøºÎ¶¨Î°ú Îã¥Í∏àÏ£º Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå
  const { data, loading, error, refetch } = useQuery(FETCH_INFUSION, {
    variables: { infusionId: infusionId as string },
    skip: !infusionId,
  });

  // GraphQL mutation - UPDATE
  const [updateInfusion, { loading: isUpdating }] = useMutation(
    UPDATE_INFUSION,
    {
      onCompleted: (data) => {
        console.log("Îã¥Í∏àÏ£º ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å:", data);
        setIsSaving(false);
        setShowUpdateSuccessModal(true);
      },
      onError: (error) => {
        console.error("Îã¥Í∏àÏ£º ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®:", error);
        setIsSaving(false);
        setErrorMessage("Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: " + error.message);
        setShowError(true);
        setTimeout(() => setShowError(false), 3000);
      },
    }
  );

  // GraphQL mutation - DELETE
  const [deleteInfusion, { loading: isDeleting }] = useMutation(
    DELETE_INFUSION,
    {
      onCompleted: () => {
        console.log("Îã¥Í∏àÏ£º ÏÇ≠Ï†ú ÏôÑÎ£å");
        setShowDeleteModal(false);
        setShowDeleteSuccessModal(true);
      },
      onError: (error) => {
        console.error("Îã¥Í∏àÏ£º ÏÇ≠Ï†ú Ïã§Ìå®:", error);
        setShowDeleteModal(false);
        setDeleteErrorMessage(error.message);
        setShowDeleteErrorModal(true);
      },
      // Î™©Î°ù ÏøºÎ¶¨Îßå Î¨¥Ìö®Ìôî (ÌòÑÏû¨ ÏÉÅÏÑ∏ ÌéòÏù¥ÏßÄÎäî Í±¥ÎìúÎ¶¨ÏßÄ ÏïäÏùå)
      update(cache, { data }) {
        if (data?.deleteInfusion) {
          // fetchInfusions Î™©Î°ù ÏøºÎ¶¨Îßå Î¨¥Ìö®Ìôî
          cache.evict({ fieldName: "fetchInfusions" });
          cache.gc();
        }
      },
    }
  );

  // API Îç∞Ïù¥ÌÑ∞Î•º Í∏∞Î∞òÏúºÎ°ú thoughts Ï¥àÍ∏∞Ìôî
  useEffect(() => {
    if (data?.fetchInfusion?.infusionDetails) {
      const newThoughts: Record<string, string> = {
        ONE_WEEK: "",
        ONE_MONTH: "",
        ONE_YEAR: "",
        TEN_YEARS: "",
      };

      // periodTypeÏóê Îî∞Î•∏ defaultValue ÏÑ§Ï†ï
      data.fetchInfusion.infusionDetails.forEach((detail: any) => {
        if (detail.periodType && detail.description) {
          newThoughts[detail.periodType] = detail.description;
        }
      });

      setThoughts(newThoughts);
    }
  }, [data]);

  // ÏãúÍ∞ÑÎ≥Ñ ÏÉùÍ∞Å Îç∞Ïù¥ÌÑ∞
  const thoughtPeriods = [
    {
      key: PeriodType.ONE_WEEK,
      label: "1Ï£º Îí§",
      icon: "üóìÔ∏è",
      iconBg: "#fef3c7",
      iconColor: "#92400e",
    },
    {
      key: PeriodType.ONE_MONTH,
      label: "1Îã¨ Îí§",
      icon: "üóìÔ∏è",
      iconBg: "#fce7f3",
      iconColor: "#be185d",
    },
    {
      key: PeriodType.ONE_YEAR,
      label: "1ÎÖÑ Îí§",
      icon: "üóìÔ∏è",
      iconBg: "#e0e7ff",
      iconColor: "#3730a3",
    },
    {
      key: PeriodType.TEN_YEARS,
      label: "10ÎÖÑ Îí§",
      icon: "‚è∞",
      iconBg: "#dcfce7",
      iconColor: "#166534",
    },
  ];

  // Ïπ¥ÌÖåÍ≥†Î¶¨ Ïù¥Î¶Ñ Î≥ÄÌôò
  const getCategoryName = (category: string) => {
    switch (category) {
      case "DECISION":
        return "ÏùòÏÇ¨Í≤∞Ï†ï";
      case "STRESS":
        return "Ïä§Ìä∏Î†àÏä§";
      case "CONSUMPTION":
        return "ÏÜåÎπÑ";
      default:
        return "Í∏∞ÌÉÄ";
    }
  };

  // ÎÇ†Ïßú Ìè¨Îß∑ÌåÖ Ìï®Ïàò
  const formatDate = (dateString: string) => {
    let date: Date;

    if (dateString.includes("T")) {
      date = new Date(dateString);
    } else if (dateString.includes("-")) {
      date = new Date(dateString + "T00:00:00");
    } else {
      date = new Date(dateString);
    }

    if (isNaN(date.getTime())) {
      return "ÎÇ†Ïßú Ï†ïÎ≥¥ ÏóÜÏùå";
    }

    const year = date.getFullYear();
    const month = date.getMonth() + 1;
    const day = date.getDate();

    return `${year}ÎÖÑ ${month}Ïõî ${day}Ïùº`;
  };

  // Îí§Î°úÍ∞ÄÍ∏∞ Ìï∏Îì§Îü¨
  const handleBack = () => {
    router.back();
  };

  // ÏÉùÍ∞Å ÏûÖÎ†• Ìï∏Îì§Îü¨
  const handleThoughtChange = (period: string, value: string) => {
    setThoughts((prev) => ({
      ...prev,
      [period]: value,
    }));
  };

  // ÏïÑÏΩîÎîîÏñ∏ ÌÜ†Í∏Ä Ìï∏Îì§Îü¨
  const handleAccordionToggle = (period: string) => {
    setExpandedThoughts((prev) => ({
      ...prev,
      [period]: !prev[period],
    }));
  };

  // ÏÇ≠Ï†ú Î≤ÑÌäº ÌÅ¥Î¶≠ Ìï∏Îì§Îü¨
  const handleDeleteClick = () => {
    setShowDeleteModal(true);
  };

  // ÏÇ≠Ï†ú ÌôïÏù∏ Ìï∏Îì§Îü¨
  const handleDeleteConfirm = async () => {
    try {
      await deleteInfusion({
        variables: { infusionId: infusionId as string },
      });
    } catch (error) {
      console.error("Delete error:", error);
    }
  };

  // ÏÇ≠Ï†ú Ï∑®ÏÜå Ìï∏Îì§Îü¨
  const handleDeleteCancel = () => {
    setShowDeleteModal(false);
  };

  // ÏÇ≠Ï†ú ÏÑ±Í≥µ Î™®Îã¨ Îã´Í∏∞ Ìï∏Îì§Îü¨
  const handleDeleteSuccessModalClose = () => {
    setShowDeleteSuccessModal(false);
    router.push("/infusion");
  };

  // ÏÇ≠Ï†ú ÏóêÎü¨ Î™®Îã¨ Îã´Í∏∞ Ìï∏Îì§Îü¨
  const handleDeleteErrorModalClose = () => {
    setShowDeleteErrorModal(false);
    setDeleteErrorMessage("");
  };

  // ÏóÖÎç∞Ïù¥Ìä∏ ÏÑ±Í≥µ Î™®Îã¨ Îã´Í∏∞ Ìï∏Îì§Îü¨
  const handleUpdateSuccessModalClose = () => {
    setShowUpdateSuccessModal(false);
    router.push("/infusion");
  };

  // Ï†ÄÏû• Ìï∏Îì§Îü¨
  const handleSave = async () => {
    setIsSaving(true);
    setShowError(false);

    try {
      const infusion = data?.fetchInfusion;

      if (!infusion) {
        setErrorMessage("Îã¥Í∏àÏ£º Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.");
        setShowError(true);
        setIsSaving(false);
        return;
      }

      // infusionDetails Î∞∞Ïó¥ ÏÉùÏÑ± (Îπà Í∞íÏùÄ Ï†úÏô∏)
      const infusionDetails = Object.entries(thoughts)
        .filter(([_, description]) => description.trim() !== "")
        .map(([periodType, description]) => ({
          description: description.trim(),
          periodType: periodType as PeriodType,
        }));

      // ÏµúÏÜå ÌïòÎÇòÏùò ÏÉùÍ∞ÅÏù¥ ÏûÖÎ†•ÎêòÏóàÎäîÏßÄ ÌôïÏù∏
      if (infusionDetails.length === 0) {
        setErrorMessage("ÏµúÏÜå ÌïòÎÇòÏùò ÏãúÍ∞ÑÎåÄÏóê ÏÉùÍ∞ÅÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
        setShowError(true);
        setIsSaving(false);
        return;
      }

      // GraphQL Ïä§ÌÇ§ÎßàÏóê ÎßûÍ≤å Îç∞Ïù¥ÌÑ∞ Î≥ÄÌôò
      const updateInfusionInput = {
        title: infusion.title,
        category: infusion.category,
        description: infusion.description,
        infusionDetails: infusionDetails,
      };

      console.log("Îã¥Í∏àÏ£º ÏóÖÎç∞Ïù¥Ìä∏ ÏöîÏ≤≠:", {
        infusionId,
        updateInfusionInput,
      });

      // GraphQL mutation Ïã§Ìñâ
      await updateInfusion({
        variables: {
          infusionId: infusionId as string,
          updateInfusionInput: updateInfusionInput,
        },
      });
    } catch (error) {
      console.error("Îã¥Í∏àÏ£º Ï†ÄÏû• Ï§ë Ïò§Î•ò:", error);
      setIsSaving(false);
    }
  };

  // ÎîîÏûêÏù∏ ÏòµÏÖò 1: ÏïÑÏΩîÎîîÏñ∏ Ïä§ÌÉÄÏùº
  const renderAccordionDesign = () => (
    <ThoughtsSection>
      {thoughtPeriods.map((period) => (
        <ThoughtItem key={period.key} isExpanded={expandedThoughts[period.key]}>
          <ThoughtHeader onClick={() => handleAccordionToggle(period.key)}>
            <ThoughtTitle>
              <ThoughtLabel>{period.label}</ThoughtLabel>
            </ThoughtTitle>
            <ThoughtArrow isExpanded={expandedThoughts[period.key]}>
              ‚ñº
            </ThoughtArrow>
          </ThoughtHeader>
          <ThoughtContent isExpanded={expandedThoughts[period.key]}>
            <ThoughtTextarea
              placeholder={`Ïñ¥ÎñªÍ≤å ÏÉùÍ∞ÅÌïòÍ≥† ÏûàÎÇòÏöî?`}
              value={thoughts[period.key]}
              onChange={(e) => handleThoughtChange(period.key, e.target.value)}
            />
          </ThoughtContent>
        </ThoughtItem>
      ))}
    </ThoughtsSection>
  );

  // Î°úÎî© ÏÉÅÌÉú
  if (loading) {
    return (
      <Container gradient={currentTheme.gradient}>
        <TopAppBar>
          <AppBarContent>
            <BackButton onClick={handleBack}>‚Üê</BackButton>
            <AppInfo>
              <AppTitle>Îã¥Í∏àÏ£º ÏÉÅÏÑ∏</AppTitle>
              <AppSubtitle>Î°úÎî© Ï§ë...</AppSubtitle>
            </AppInfo>
            <div style={{ width: "40px" }}></div>
          </AppBarContent>
        </TopAppBar>
        <ContentWrapper>
          <Card>
            <CardContent>
              <div style={{ textAlign: "center", padding: "40px" }}>
                Îã¥Í∏àÏ£º Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...
              </div>
            </CardContent>
          </Card>
        </ContentWrapper>
      </Container>
    );
  }

  // ÏóêÎü¨ ÏÉÅÌÉú
  if (error) {
    return (
      <Container gradient={currentTheme.gradient}>
        <TopAppBar>
          <AppBarContent>
            <BackButton onClick={handleBack}>‚Üê</BackButton>
            <AppInfo>
              <AppTitle>Îã¥Í∏àÏ£º ÏÉÅÏÑ∏</AppTitle>
              <AppSubtitle>Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§</AppSubtitle>
            </AppInfo>
            <div style={{ width: "40px" }}></div>
          </AppBarContent>
        </TopAppBar>
        <ContentWrapper>
          <Card>
            <CardContent>
              <div style={{ textAlign: "center", padding: "40px" }}>
                <p>Îã¥Í∏àÏ£º Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</p>
                <p>{error.message}</p>
              </div>
            </CardContent>
          </Card>
        </ContentWrapper>
      </Container>
    );
  }

  const infusion = data?.fetchInfusion;

  if (!infusion) {
    return (
      <Container gradient={currentTheme.gradient}>
        <TopAppBar>
          <AppBarContent>
            <BackButton onClick={handleBack}>‚Üê</BackButton>
            <AppInfo>
              <AppTitle>Îã¥Í∏àÏ£º ÏÉÅÏÑ∏</AppTitle>
              <AppSubtitle>Îã¥Í∏àÏ£ºÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§</AppSubtitle>
            </AppInfo>
            <div style={{ width: "40px" }}></div>
          </AppBarContent>
        </TopAppBar>
        <ContentWrapper>
          <Card>
            <CardContent>
              <div style={{ textAlign: "center", padding: "40px" }}>
                Ìï¥Îãπ Îã¥Í∏àÏ£ºÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.
              </div>
            </CardContent>
          </Card>
        </ContentWrapper>
      </Container>
    );
  }

  return (
    <Container gradient={currentTheme.gradient}>
      {/* ÏÇ≠Ï†ú ÌôïÏù∏ Î™®Îã¨ */}
      <CheckModal
        isOpen={showDeleteModal}
        onClose={handleDeleteCancel}
        onConfirm={handleDeleteConfirm}
        title="Îã¥Í∏àÏ£º ÏÇ≠Ï†ú"
        message={`Ï†ïÎßêÎ°ú Ïù¥ Îã¥Í∏àÏ£ºÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`}
        confirmText="üóëÔ∏è ÏÇ≠Ï†ú"
        cancelText="Ï∑®ÏÜå"
        isLoading={isDeleting}
        type="danger"
        theme={currentTheme}
      />

      {/* ÏÇ≠Ï†ú ÏÑ±Í≥µ Î™®Îã¨ */}
      <AlertModal
        isOpen={showDeleteSuccessModal}
        onClose={handleDeleteSuccessModalClose}
        title="ÏÇ≠Ï†ú ÏôÑÎ£å"
        message="Îã¥Í∏àÏ£ºÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§."
        buttonText="ÌôïÏù∏"
        type="success"
        theme={currentTheme}
      />

      {/* ÏÇ≠Ï†ú ÏóêÎü¨ Î™®Îã¨ */}
      <AlertModal
        isOpen={showDeleteErrorModal}
        onClose={handleDeleteErrorModalClose}
        title="ÏÇ≠Ï†ú Ïã§Ìå®"
        message={`ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.\n${deleteErrorMessage}`}
        buttonText="ÌôïÏù∏"
        type="error"
        theme={currentTheme}
      />

      {/* ÏóÖÎç∞Ïù¥Ìä∏ ÏÑ±Í≥µ Î™®Îã¨ */}
      <AlertModal
        isOpen={showUpdateSuccessModal}
        onClose={handleUpdateSuccessModalClose}
        title="Ï†ÄÏû• ÏôÑÎ£å"
        message="Îã¥Í∏àÏ£ºÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§."
        buttonText="ÌôïÏù∏"
        type="success"
        theme={currentTheme}
      />

      {/* Top App Bar */}
      <TopAppBar>
        <AppBarContent>
          <BackButton onClick={handleBack}>‚Üê</BackButton>
          <AppInfo>
            <AppTitle>Îã¥Í∏àÏ£º ÏÉÅÏÑ∏</AppTitle>
            <AppSubtitle>ÏãúÍ∞ÑÏù¥ ÏßÄÎÇòÎ©∞ Î≥ÄÌïòÎäî ÏÉùÍ∞ÅÏùÑ Í∏∞Î°ùÌï¥Î≥¥ÏÑ∏Ïöî</AppSubtitle>
          </AppInfo>
          {/* ÏÇ≠Ï†ú Î≤ÑÌäº Ï∂îÍ∞Ä (todoDetailÍ≥º ÎèôÏùºÌïú Ïä§ÌÉÄÏùº) */}
          <ActionButtons>
            <ActionButton
              onClick={handleDeleteClick}
              title="ÏÇ≠Ï†ú"
              disabled={isDeleting}
            >
              {isDeleting ? "‚è≥" : "üóëÔ∏è"}
            </ActionButton>
          </ActionButtons>
        </AppBarContent>
      </TopAppBar>

      {/* Content */}
      <ContentWrapper>
        {/* ÏóêÎü¨ Î©îÏãúÏßÄÎßå Ïú†ÏßÄ (ÏÑ±Í≥µ Î©îÏãúÏßÄÎäî Î™®Îã¨Î°ú ÎåÄÏ≤¥) */}
        {showError && (
          <div
            style={{
              padding: "16px",
              marginBottom: "16px",
              backgroundColor: "#fee2e2",
              color: "#991b1b",
              borderRadius: "8px",
              textAlign: "center",
              fontWeight: "500",
            }}
          >
            {errorMessage}
          </div>
        )}

        {/* Í∏∞Î≥∏ Ï†ïÎ≥¥ */}
        <Card>
          <TitleSection>
            <Title>{infusion.title}</Title>
            <div
              style={{
                display: "flex",
                gap: "12px",
                alignItems: "center",
                flexWrap: "wrap",
              }}
            >
              <CategoryBadge category={infusion.category}>
                {getCategoryName(infusion.category)}
              </CategoryBadge>
              <DateText>{formatDate(infusion.createdAt)}</DateText>
            </div>
          </TitleSection>
          <Description>{infusion.description}</Description>
        </Card>

        {/* ÏãúÍ∞ÑÎ≥Ñ ÏÉùÍ∞Å ÏûÖÎ†• */}
        <Card>
          <CardHeader>
            <CardTitle>ÏãúÍ∞ÑÎ≥Ñ ÏÉùÍ∞Å Í∏∞Î°ù</CardTitle>
          </CardHeader>
          <CardContent>
            {/* ÏÑ†ÌÉùÎêú ÎîîÏûêÏù∏ Î†åÎçîÎßÅ */}
            {designOption === "accordion" && renderAccordionDesign()}

            <ButtonGroup>
              <Button
                theme={currentTheme}
                variant="secondary"
                onClick={handleBack}
                disabled={isSaving || isDeleting}
              >
                Ï∑®ÏÜå
              </Button>
              <Button
                theme={currentTheme}
                onClick={handleSave}
                disabled={isSaving || isDeleting}
              >
                {isSaving ? "Ï†ÄÏû• Ï§ë..." : "Ï†ÄÏû•ÌïòÍ∏∞"}
              </Button>
            </ButtonGroup>
          </CardContent>
        </Card>
      </ContentWrapper>
    </Container>
  );
}
